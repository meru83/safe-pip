# 第4章: pip制御バッチの応用と拡張

---

## 🎯 章の目的

前章では、グローバル環境の誤操作を防ぐために `pip.bat` を作成し、安全な `pip` 利用環境を整備しました。本章では、さらにこの仕組みを発展させ、より高度な制御や運用を可能にする応用例を紹介します。

---

## ⚙ 応用アイデア

### 1. 仮想環境の未有効時に自動で中止

現在の `pip.bat` は仮想環境外でも実行確認の上、続行できますが、
これを**問答無用で終了**させることも可能です：

```bat
if not defined VIRTUAL_ENV (
    echo 仮想環境が有効ではありません。
    echo 処理を中断します。
    exit /b
)
```

### 2. 許可されたコマンドのパターンマッチ（前方一致）

`pip show requests` のような **引数付きコマンド**に対応するため、
前方一致でマッチさせるロジックに変更することが可能です：

```bat
for /f "usebackq tokens=* delims=" %%C in ("%ALLOW_FILE%") do (
    echo %* | findstr /b /c:"%%C" >nul
    if not errorlevel 1 goto :SAFE_EXEC
)
```

### 3. エラーログの追加

失敗したコマンドを別ログに記録することで、失敗操作のトレースも可能になります。

```bat
if errorlevel 1 (
    echo [%date% %time%] ERROR: pip %* >> %LOG_DIR%\pip_errors_!TODAY!.log
)
```

### 4. 日別ログの自動整頓（週次/日次アーカイブ化）

バッチファイルに日時判定を追加して、定期的にログをまとめるようにすることもできます。
これは `PowerShell` や `Python` スクリプトとの連携で柔軟に実装可能です。

---

## 📂 複数環境対応（Python複数バージョン）

複数の Python バージョンがインストールされている場合、
`python -m pip` の部分を特定のバージョンに固定したいことがあります：

```bat
C:\Users\username\AppData\Local\Programs\Python\Python311\python.exe -m pip %*
```

> ※ただし、この固定は仮想環境との親和性が低いため推奨はされません。

---

## 📝 その他の工夫

* `pip list --format=json` を活用し、Python スクリプトから解析・整形表示
* PowerShell 上でも視認性を意識した `Write-Host` 活用（色分けなど）
* 許可コマンドリストを Git 管理し、チーム全体でルール統一

---

## ✅ この章のまとめ

* `pip.bat` はロジック次第で柔軟に拡張・応用できる
* コマンドの前方一致やエラー記録機能などで、実用性が向上
* 複数環境対応やログ整頓にも発展可能
* チーム開発・教育用途でも安全性と管理性を両立

👉 [次の章へ](step5.md)
